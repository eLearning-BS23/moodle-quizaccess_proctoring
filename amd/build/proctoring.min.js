function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}var isCameraAllowed=!1;define("quizaccess_proctoring/proctoring",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){function hideButtons(){$(".mod_quiz-next-nav").prop("disabled",!0),$(".submitbtns").html('<p class="text text-red red">You need to enable web camera before submitting this quiz!</p>')}$("#id_submitbutton").prop("disabled",!0),$((function(){$("#id_submitbutton").prop("disabled",!0),$("#id_proctoring").on("change",(function(){this.checked&&isCameraAllowed?$("#id_submitbutton").prop("disabled",!1):$("#id_submitbutton").prop("disabled",!0)}))}));var _ref,_ref2,takepicturedelay=3e4,extractFaceFromBox=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(imageRef,box,croppedImage){var regionsToExtract,faceImages;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return regionsToExtract=[new faceapi.Rect(box.x,box.y,box.width,box.height)],_context.next=3,faceapi.extractFaces(imageRef,regionsToExtract);case 3:0===(faceImages=_context.sent).length||faceImages.forEach((function(cnv){croppedImage.src=cnv.toDataURL()}));case 5:case"end":return _context.stop()}}),_callee)}))),function(_x,_x2,_x3){return _ref.apply(this,arguments)}),detectface=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(input,croppedImage){var output,detections;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,faceapi.detectAllFaces(input);case 2:if(0!==(output=_context2.sent).length){_context2.next=8;break}return console.log("No face found"),_context2.abrupt("return",!1);case 8:return console.log("Face found"),detections=output[0].box,_context2.next=12,extractFaceFromBox(input,detections,croppedImage);case 12:return _context2.abrupt("return",_context2.sent);case 13:case"end":return _context2.stop()}}),_callee2)}))),function(_x4,_x5){return _ref2.apply(this,arguments)});return{setup:function(props,modelurl){return _asyncToGenerator(regeneratorRuntime.mark((function _callee6(){var width,height,streaming,data,video,canvas,photo,clearphoto,takepicture;return regeneratorRuntime.wrap((function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:if(takepicturedelay=props.camshotdelay,null===document.getElementById("page-mod-quiz-summary")||!document.getElementById("page-mod-quiz-summary").innerHTML.length){_context6.next=3;break}return _context6.abrupt("return",!1);case 3:if(null===document.getElementById("page-mod-quiz-review")||!document.getElementById("page-mod-quiz-review").innerHTML.length){_context6.next=5;break}return _context6.abrupt("return",!1);case 5:return width=props.image_width,height=0,streaming=!1,data=null,$("#mod_quiz_navblock").append('<div class="card-body p-3"><h3 class="no text-left">Webcam</h3> <br/><video id="video">Video stream not available.</video><img id="cropimg" src="" alt=""/><canvas id="canvas" style="display:none;"></canvas><div class="output" style="display:none;"><img id="photo" alt="The picture will appear in this box."/></div></div>'),video=document.getElementById("video"),canvas=document.getElementById("canvas"),photo=document.getElementById("photo"),clearphoto=function(){var context=canvas.getContext("2d");context.fillStyle="#AAA",context.fillRect(0,0,canvas.width,canvas.height),data=canvas.toDataURL("image/png"),photo.setAttribute("src",data)},takepicture=function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(){var context,params,request;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:context=canvas.getContext("2d"),width&&height?(canvas.width=width,canvas.height=height,context.drawImage(video,0,0,width,height),data=canvas.toDataURL("image/png"),photo.setAttribute("src",data),props.webcampicture=data,Promise.all([faceapi.nets.ssdMobilenetv1.loadFromUri(modelurl)]).then(_asyncToGenerator(regeneratorRuntime.mark((function _callee3(){var croppedImage;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return croppedImage=$("#cropimg"),_context3.next=3,detectface(photo,croppedImage);case 3:case"end":return _context3.stop()}}),_callee3)})))),"quizaccess_proctoring_send_camshot",params={courseid:props.courseid,screenshotid:props.id,quizid:props.quizid,webcampicture:data,imagetype:1},request={methodname:"quizaccess_proctoring_send_camshot",args:params},Ajax.call([request])[0].done((function(res){res.warnings.length<1||video&&Notification.addNotification({message:"Something went wrong during taking the image.",type:"error"})})).fail(Notification.exception)):clearphoto();case 2:case"end":return _context4.stop()}}),_callee4)})));return function(){return _ref3.apply(this,arguments)}}(),navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((function(stream){video.srcObject=stream,video.play(),isCameraAllowed=!0})).catch((function(){hideButtons()})),video?(video.addEventListener("canplay",(function(){streaming||(height=video.videoHeight/(video.videoWidth/width),isNaN(height)&&(height=width/(4/3)),video.setAttribute("width",width),video.setAttribute("height",height),canvas.setAttribute("width",width),canvas.setAttribute("height",height),streaming=!0)}),!1),video.addEventListener("click",function(){var _ref5=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(ev){return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return _context5.next=2,takepicture();case 2:ev.preventDefault();case 3:case"end":return _context5.stop()}}),_callee5)})));return function(_x6){return _ref5.apply(this,arguments)}}(),!1),setTimeout(takepicture,3e3),setInterval(takepicture,takepicturedelay)):hideButtons(),_context6.abrupt("return",!0);case 18:case"end":return _context6.stop()}}),_callee6)})))()},init:function(props){return _asyncToGenerator(regeneratorRuntime.mark((function _callee11(){var height,streaming,video,canvas,photo,data,width,startup,_startup,clearphoto,takepicture,_takepicture;return regeneratorRuntime.wrap((function(_context11){for(;;)switch(_context11.prev=_context11.next){case 0:return _takepicture=function(){return _takepicture=_asyncToGenerator(regeneratorRuntime.mark((function _callee10(){var context,params,request;return regeneratorRuntime.wrap((function(_context10){for(;;)switch(_context10.prev=_context10.next){case 0:context=canvas.getContext("2d"),width&&height?($(document).trigger("screenshoottaken"),canvas.width=width,canvas.height=height,context.drawImage(video,0,0,width,height),data=canvas.toDataURL("image/png"),photo.setAttribute("src",data),"quizaccess_proctoring_send_camshot",params={courseid:props.courseid,screenshotid:props.id,quizid:props.quizid,webcampicture:data,imagetype:1},request={methodname:"quizaccess_proctoring_send_camshot",args:params},Ajax.call([request])[0].done(function(){var _ref7=_asyncToGenerator(regeneratorRuntime.mark((function _callee9(res){return regeneratorRuntime.wrap((function(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:res.warnings.length<1||Notification.addNotification({message:"Something went wrong during taking screenshot.",type:"error"});case 1:case"end":return _context9.stop()}}),_callee9)})));return function(_x8){return _ref7.apply(this,arguments)}}()).fail(Notification.exception)):clearphoto();case 2:case"end":return _context10.stop()}}),_callee10)}))),_takepicture.apply(this,arguments)},takepicture=function(){return _takepicture.apply(this,arguments)},clearphoto=function(){if(isCameraAllowed){var context=canvas.getContext("2d");context.fillStyle="#AAA",context.fillRect(0,0,canvas.width,canvas.height),data=canvas.toDataURL("image/png"),photo.setAttribute("src",data)}else hideButtons()},_startup=function(){return _startup=_asyncToGenerator(regeneratorRuntime.mark((function _callee8(){return regeneratorRuntime.wrap((function(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:video=document.getElementById("video"),canvas=document.getElementById("canvas"),photo=document.getElementById("photo"),video?(navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((function(stream){video.srcObject=stream,video.play(),isCameraAllowed=!0})).catch((function(){Notification.addNotification({message:props.allowcamerawarning,type:"warning"}),hideButtons()})),video.addEventListener("canplay",(function(){streaming||(height=video.videoHeight/(video.videoWidth/width),isNaN(height)&&(height=width/(4/3)),video.setAttribute("width",width),video.setAttribute("height",height),canvas.setAttribute("width",width),canvas.setAttribute("height",height),streaming=!0)}),!1),video.addEventListener("click",function(){var _ref6=_asyncToGenerator(regeneratorRuntime.mark((function _callee7(ev){return regeneratorRuntime.wrap((function(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return _context7.next=2,takepicture();case 2:ev.preventDefault();case 3:case"end":return _context7.stop()}}),_callee7)})));return function(_x7){return _ref6.apply(this,arguments)}}(),!1)):hideButtons(),clearphoto();case 5:case"end":return _context8.stop()}}),_callee8)}))),_startup.apply(this,arguments)},startup=function(){return _startup.apply(this,arguments)},height=0,streaming=!1,video=null,canvas=null,photo=null,data=null,width=props.image_width,_context11.next=14,startup();case 14:return _context11.abrupt("return",data);case 15:case"end":return _context11.stop()}}),_callee11)})))()}}}));

//# sourceMappingURL=proctoring.min.js.map