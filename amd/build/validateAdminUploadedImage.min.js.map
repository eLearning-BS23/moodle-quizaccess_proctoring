{"version":3,"file":"validateAdminUploadedImage.min.js","sources":["../src/validateAdminUploadedImage.js"],"sourcesContent":["define(['jquery', 'core/ajax', 'core/notification', 'core/str'],\n    function($, Ajax, Notification, Str) {\n\n        const loadStrings = async function() {\n            const stringkeys = [\n                {key: 'facefound', component: 'quizaccess_proctoring'},\n                {key: 'facenotfound', component: 'quizaccess_proctoring'},\n            ];\n            try {\n                const strings = await Str.get_strings(stringkeys);\n                return {\n                    facefound: strings[0],\n                    facenotfound: strings[1]\n                };\n            } catch (error) {\n                Notification.exception(error);\n            }\n        };\n\n        let notificationShown = 0;\n\n        const clearPreviousNotifications = () => {\n            try {\n                let alerts = document.getElementsByClassName('alert');\n                if(alerts.length > 0) {\n                    Array.from(alerts).forEach(alert => {\n                        alert.style.display = 'none';\n                    });\n                    notificationShown = 0;\n                }\n            } catch (error) {\n                Notification.exception(error);\n            }\n        };\n\n        const displayNotification = (message, type) => {\n            Notification.addNotification({\n                message,\n                type\n            });\n        };\n\n        // Function to draw image from the box data. babel/no-unused-\n        const extractFaceFromBox = async(imageRef, box, croppedImage) => {\n            const regionsToExtract = [\n                // eslint-disable-next-line\n                new faceapi.Rect(box.x, box.y, box.width, box.height)\n            ];\n            // eslint-disable-next-line\n            let faceImages = await faceapi.extractFaces(imageRef, regionsToExtract);\n            if (faceImages.length > 0) {\n                faceImages.forEach((cnv) => {\n                    croppedImage.src = cnv.toDataURL();\n                });\n            }\n        };\n\n        // Function to detect face from the image.\n        const detectface = async(input, croppedImage) => {\n            // eslint-disable-next-line\n            const output = await faceapi.detectAllFaces(input);\n            if (output.length > 0) {\n                let detections = output[0].box;\n                await extractFaceFromBox(input, detections, croppedImage);\n            }\n        };\n\n        return {\n            async setup(modelurl) {\n                // eslint-disable-next-line\n                await faceapi.nets.ssdMobilenetv1.loadFromUri(modelurl);\n                $('#fitem_id_user_photo').append(\n                '<img id=\"cropimg\" style=\"display:none;\"/><img id=\"previewimg\" style=\"display:none;\" height=\"auto\"width=\"auto\"/>');\n                let submitBtn = document.getElementById('id_submitbutton');\n                let croppedImage = $('#cropimg');\n\n                let previewImage;\n                if (submitBtn) {\n                    submitBtn.disabled = true;\n                }\n\n                setInterval(getPreviewImage, 1000);\n                /**\n                 * Checks for the preview image in the dom\n                 *\n                 */\n                async function getPreviewImage() {\n                    let preview = document.getElementsByClassName('realpreview');\n                    const strings = await loadStrings();\n                    if (preview.length > 0) {\n                        previewImage = document.getElementById('previewimg');\n                        let imageUrlString = preview[0].src;\n                        const splitArray = imageUrlString.split(\"?\");\n\n                        if (previewImage.src !== splitArray[0]) {\n                            previewImage.src = splitArray[0];\n                        } else {\n                            return;\n                        }\n\n                        await detectface(previewImage, croppedImage);\n\n                        if (croppedImage.src) {\n                            if (submitBtn) {\n                                submitBtn.disabled = false;\n                            }\n\n                            clearPreviousNotifications();\n                            if (notificationShown == 0) {\n                                displayNotification(strings.facefound, 'success');\n                                notificationShown = 1;\n                            }\n\n                            let faceImageField = document.querySelector('[name=\"face_image\"]');\n\n                            if (faceImageField) {\n                                faceImageField.setAttribute('value', croppedImage.src);\n                            }\n                            croppedImage.src = null;\n                        } else {\n                            clearPreviousNotifications();\n                            if (notificationShown == 0) {\n                                displayNotification(strings.facenotfound, 'error');\n                                notificationShown = 1;\n                                submitBtn.disabled = true;\n                            }\n                            croppedImage.src = null;\n                            let faceImageField = document.querySelector('[name=\"face_image\"]');\n                            if (faceImageField) {\n                                faceImageField.setAttribute('value', croppedImage.src);\n                            }\n                        }\n                    } else {\n                        if(submitBtn) {\n                            submitBtn.disabled = true;\n                        }\n                    }\n                }\n                return true;\n            }\n        };\n    });\n"],"names":["define","$","Ajax","Notification","Str","notificationShown","clearPreviousNotifications","alerts","document","getElementsByClassName","length","Array","from","forEach","alert","style","display","error","exception","displayNotification","message","type","addNotification","detectface","async","input","croppedImage","output","faceapi","detectAllFaces","detections","box","imageRef","regionsToExtract","Rect","x","y","width","height","faceImages","extractFaces","cnv","src","toDataURL","extractFaceFromBox","modelurl","nets","ssdMobilenetv1","loadFromUri","append","previewImage","submitBtn","getElementById","disabled","setInterval","preview","strings","stringkeys","key","component","get_strings","facefound","facenotfound","loadStrings","splitArray","split","faceImageField","querySelector","setAttribute"],"mappings":"AAAAA,0DAAO,CAAC,SAAU,YAAa,oBAAqB,aAChD,SAASC,EAAGC,KAAMC,aAAcC,SAkBxBC,kBAAoB,QAElBC,2BAA6B,aAEvBC,OAASC,SAASC,uBAAuB,SAC1CF,OAAOG,OAAS,IACfC,MAAMC,KAAKL,QAAQM,SAAQC,QACvBA,MAAMC,MAAMC,QAAU,UAE1BX,kBAAoB,GAE1B,MAAOY,OACLd,aAAae,UAAUD,SAIzBE,oBAAsB,CAACC,QAASC,QAClClB,aAAamB,gBAAgB,CACzBF,QAAAA,QACAC,KAAAA,QAoBFE,WAAaC,MAAMC,MAAOC,sBAEtBC,aAAeC,QAAQC,eAAeJ,UACxCE,OAAOjB,OAAS,EAAG,KACfoB,WAAaH,OAAO,GAAGI,SAnBRP,OAAMQ,SAAUD,IAAKL,sBACtCO,iBAAmB,CAErB,IAAIL,QAAQM,KAAKH,IAAII,EAAGJ,IAAIK,EAAGL,IAAIM,MAAON,IAAIO,aAG9CC,iBAAmBX,QAAQY,aAAaR,SAAUC,kBAClDM,WAAW7B,OAAS,GACpB6B,WAAW1B,SAAS4B,MAChBf,aAAagB,IAAMD,IAAIE,gBAWrBC,CAAmBnB,MAAOK,WAAYJ,sBAI7C,aACSmB,gBAEFjB,QAAQkB,KAAKC,eAAeC,YAAYH,UAC9C5C,EAAE,wBAAwBgD,OAC1B,uHAIIC,aAHAC,UAAY3C,SAAS4C,eAAe,mBACpC1B,aAAezB,EAAE,mBAGjBkD,YACAA,UAAUE,UAAW,GAGzBC,kCAMQC,QAAU/C,SAASC,uBAAuB,qBACxC+C,cArFEhC,uBACViC,WAAa,CACf,CAACC,IAAK,YAAaC,UAAW,yBAC9B,CAACD,IAAK,eAAgBC,UAAW,oCAG3BH,cAAgBpD,IAAIwD,YAAYH,kBAC/B,CACHI,UAAWL,QAAQ,GACnBM,aAAcN,QAAQ,IAE5B,MAAOvC,OACLd,aAAae,UAAUD,QAyEG8C,MAClBR,QAAQ7C,OAAS,EAAG,CACpBwC,aAAe1C,SAAS4C,eAAe,oBAEjCY,WADeT,QAAQ,GAAGb,IACEuB,MAAM,QAEpCf,aAAaR,MAAQsB,WAAW,aAChCd,aAAaR,IAAMsB,WAAW,SAK5BzC,WAAW2B,aAAcxB,cAE3BA,aAAagB,IAAK,CACdS,YACAA,UAAUE,UAAW,GAGzB/C,6BACyB,GAArBD,oBACAc,oBAAoBqC,QAAQK,UAAW,WACvCxD,kBAAoB,OAGpB6D,eAAiB1D,SAAS2D,cAAc,uBAExCD,gBACAA,eAAeE,aAAa,QAAS1C,aAAagB,KAEtDhB,aAAagB,IAAM,SAChB,CACHpC,6BACyB,GAArBD,oBACAc,oBAAoBqC,QAAQM,aAAc,SAC1CzD,kBAAoB,EACpB8C,UAAUE,UAAW,GAEzB3B,aAAagB,IAAM,SACfwB,eAAiB1D,SAAS2D,cAAc,uBACxCD,gBACAA,eAAeE,aAAa,QAAS1C,aAAagB,WAIvDS,YACCA,UAAUE,UAAW,KArDJ,MAyDtB"}